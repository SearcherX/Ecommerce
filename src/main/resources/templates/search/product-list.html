<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/layouts.html :: common_head(~{::title}, ~{})}">
    <title>Товары</title>
</head>
<body class="bg-color1">
<header th:replace="~{layout/layouts.html :: menu}"></header>
<div class="container">
    <h1>Найдено: [[${productPage.getTotalElements()}]] товаров</h1>
    <div class="subcategory-products-container position-relative">
        <div th:each="product, varStat: ${productPage}" class="subcategory-product">
            <div class="img-container">
                <img th:src="@{|/img/${product.files.size() > 0 ? product.files.get(0).fileName : 'no image.jpeg'}|}"
                        th:alt="${product.productName}">
            </div>
            <a th:href="@{|/catalog/product/${product.cipher}|}">
                [[${product.productName}]]</a>
            <div class="product-buy">
                <span>[[${#numbers.formatDecimal(product.price, 3, 'WHITESPACE', 2, 'POINT')}]] ₽</span>

                <div th:with="condition=${T(home.ecommerce.service.BucketService).containsProduct(bucketItems, product)}"
                     th:remove="tag">
                    <button th:if="${condition}" class="btn-buy stat-link btn-cart">
                        В корзине
                    </button>
                    <button th:unless="${condition}" class="btn-buy stat-link" th:data-index="${varStat.index}">
                        Купить
                    </button>
                </div>
            </div>
            <div class="product-stat">
                <a th:href="@{#}" class="stat-link">Звезды</a>
                <a th:href="@{#}" class="stat-link">Отзывы</a>
            </div>
        </div>
    </div>
    <div class="mt-4" th:if="${#lists.size(pageNumbers) > 1}">
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <li th:class="|page-item ${offset <= pageNumbers[0] ? 'disabled': ''}|">
                    <a class="page-link" th:href="${offset - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <div th:each="page, stat: ${pageNumbers}" th:remove="tag">
                    <!--                        добавить ... перед последней страницей-->
                    <li class="page-item disabled"
                        th:if="${stat.last && pageNumbers[__${#lists.size(pageNumbers) - 2}__] + 1 != pageNumbers[__${#lists.size(pageNumbers) - 1}__]}">
                        <a class="page-link" href="#">...</a>
                    </li>
                    <li th:class="|page-item ${page == offset ? 'pagination-widget__page_active' : ''}|"
                        th:aria-current="${page == offset ? 'page' : ''}">
                        <a class="page-link"
                           th:href="@{|/search/?str=${simpleFilter}&offset=${page}|}">[[${page}]]</a>
                    </li>
                    <!--                        добавить ... после первой страницы-->
                    <li class="page-item disabled"
                        th:if="${stat.first && pageNumbers[0] + 1 != pageNumbers[1]}">
                        <a class="page-link" href="#">...</a>
                    </li>
                </div>
                <li th:class="|page-item ${offset >= pageNumbers[__${#lists.size(pageNumbers) - 1}__] ? 'disabled': ''}|">
                    <a class="page-link" th:href="${offset + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
<script th:src="@{/webjars/bootstrap/5.2.2/dist/js/bootstrap.bundle.js}"></script>
</body>
</html>

<script th:inline="javascript">
    document.querySelectorAll(".btn-buy").forEach(btn => btn.addEventListener("click", async (e) => {
        if (e.target.className.includes("btn-cart")) {
            location.replace("/bucket")
        } else {
            const productList = [[${productList}]];
            const index = +e.target.dataset.index;
            const url = "/bucket/add?productId=" + productList[index]["id"];

            const response = await fetch(url, {
                method: "POST",
            });

            if (response.url.includes("/login")) {
                location.replace(response.url);
            } else {
                e.target.textContent = "В корзине";
                e.target.classList.add("btn-cart");
            }
        }
    }))
</script>